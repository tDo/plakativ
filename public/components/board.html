<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="user-data.html">
<link rel="import" href="board-top-bar.html">
<link rel="import" href="column.html">

<dom-module id="board-element">
    <link rel="import" type="css" href="/css/board.css">

    <template>
        <iron-ajax
            id            = "boardLoader"
            content-type  = "application/json"
            handle-as     = "json"
            on-response   = "handleBoardLoaded"></iron-ajax>
        <iron-ajax
            id            = "columnCreator"
            method        = "POST"
            content-type  = "application/json"
            handle-as     = "json"
            on-response   = "handleColumnCreated"></iron-ajax>
        <iron-ajax
            id           = "columnMover"
            method       = "PUT"
            content-type = "application/json"
            handle-as    = "json"
            on-response  = "handleColumnMoved"></iron-ajax>


        <div class="board">
            <board-top-bar-element board="{{board}}"></board-top-bar-element>

            <div class="wrapper">
                <div class="columns">
                    <template is="dom-repeat" items="{{board.Columns}}">
                        <column-element board-id="[[board.id]]" column="{{item}}"></column-element>
                    </template>

                    <div>
                        <composer-element for-which="Column"></composer-element>
                    </div>
                </div>

                <div class="sidebar">
                    I am a sidebar!
                </div>
            </div>

        </div>

    </template>

    <script>
        Polymer({
            is: 'board-element',
            properties: {
                boardId: Number,
                board: Object
            },

            listeners: {
                requestBoardUpdate: 'requestBoardUpdate',
                createColumn:       'createColumn'
            },

            ready: function() {
                var that = this;

                function addColumn(column, index) {
                    that.splice('board.Columns', index, 0, column);
                    that.moveColumn(column.id, index + 1)
                }

                function removeColumn(index) {
                    that.splice('board.Columns', index, 1);
                }

                function updateColumnPosition(oldIndex, newIndex) {
                    var card = that.splice('board.Columns', oldIndex, 1)[0];
                    addColumn(card, newIndex);
                }


                this.sortableColumns = Sortable.create(this.$$('.columns'), {
                    group: 'columns',
                    draggable: 'column-element',
                    handle: '.column-drag-handle',
                    ghostClass: 'sortable-ghost',
                    delay: 100,
                    scroll: true,
                    scrollSensitivity: 30,
                    scrollSpeed: 10,

                    onAdd: function(evt) {
                        addColumn(evt.item.get('column'), evt.newIndex);
                    },

                    onRemove: function(evt) {
                        removeColumn(evt.oldIndex);
                    },

                    onUpdate: function(evt) {
                        updateColumnPosition(evt.oldIndex, evt.newIndex);
                    }
                });

                this.fire('requestBoardUpdate');
            },

            requestBoardUpdate: function(e) {
                var boardId = this.get('boardId');
                var r       = this.$.boardLoader;
                r.url       = '/boards/' + boardId;
                this.$.boardLoader.generateRequest();
            },

            handleBoardLoaded: function(req) {
                // TODO: Error handling when content not provided?
                this.set('board', req.detail.response);
            },

            createColumn: function(e) {
                var title   = e.detail.content;
                var boardId = this.get('boardId');
                var r       = this.$.columnCreator;
                r.url       = '/boards/' + boardId + '/columns';
                r.body      = JSON.stringify({ title: title });
                r.generateRequest();
            },

            handleColumnCreated: function(req) {
                // TODO: We should find about about errors...
                this.fire('requestBoardUpdate');
            },

            moveColumn: function(columnId, offset) {
                var boardId = this.get('boardId');
                var r       = this.$.columnMover;
                r.url       = '/boards/' + boardId + '/columns/' + columnId + '/position';
                r.body      = JSON.stringify({ offset: offset });
                r.generateRequest();
            },

            handleColumnMoved: function() {
                console.log('Moved some column');
                this.fire('requestBoardUpdate');
            }
        });
    </script>
</dom-module>